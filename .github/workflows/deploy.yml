name: Deploy Proyecto VPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      # Necesario para subir y descargar de ghcr.io
      contents: read
      packages: write 
      
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js & dependencies
        uses: actions/setup-node@v3
        with:
          node-version: 18
      
      # Correr Pruebas (asumiendo que est치n en la carpeta backend)
      - name: Run tests (Supertest)
        run: |
          cd backend
          npm ci # Instalar dependencias
          npm test

      # --- 游냡 Configuraci칩n y Subida a GHCR ---
      
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # Usar el token por defecto (GITHUB_TOKEN)
          password: ${{ secrets.GITHUB_TOKEN }} 

      - name: Build and Push Docker images
        uses: docker/build-push-action@v4
        with:
          context: . # Contexto: La ra칤z del proyecto
          push: true
          # Tags para las im치genes de Backend y Frontend
          tags: |
            ghcr.io/${{ github.repository }}/backend:${{ github.sha }}
            ghcr.io/${{ github.repository }}/frontend:${{ github.sha }}
          # Especificar los Dockerfiles correctos para multi-stage build o multi-servicios
          file: ./Dockerfile # Asume un solo Dockerfile. Si tienes varios, necesitas m칰ltiples 'build-push-action'
          # Nota: Si tienes un Dockerfile por carpeta (backend/Dockerfile, frontend/Dockerfile),
          # necesitar치s dos pasos 'Build and Push' distintos, uno para cada servicio.

      # --- 游 Despliegue a VPS (Blue-Green) ---
      
      - name: Deploy to VPS (Blue-Green)
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.VPS_IP }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
            # Moverse al directorio del proyecto
            cd ~/Proyecto-vps

            # Exportar variables para el docker-compose.yml
            export GH_REPO=${{ github.repository }}
            export IMAGE_TAG=${{ github.sha }}
            
            # Login en el VPS (necesario para el Pull)
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            
            # 1. Detecci칩n de color activo (tu l칩gica)
            if docker ps --filter "name=backend_blue" | grep backend_blue; then
              NEW_COLOR=green
              OLD_COLOR=blue
            else
              NEW_COLOR=blue
              OLD_COLOR=green
            fi
            
            NEW_BACKEND=backend_${NEW_COLOR}
            NEW_FRONTEND=frontend_${NEW_COLOR}
            OLD_BACKEND=backend_${OLD_COLOR}
            OLD_FRONTEND=frontend_${OLD_COLOR}

            echo "Despliegue a color: ${NEW_COLOR}"

            # 2. Pull de la nueva imagen (usa la imagen subida con el SHA)
            docker compose pull ${NEW_BACKEND} ${NEW_FRONTEND}
            
            # 3. Levantar nuevo contenedor (El compose ya tiene las variables)
            docker compose up -d ${NEW_BACKEND} ${NEW_FRONTEND}
            
            # 4. Esperar la salud del nuevo contenedor (CR칈TICO antes de cambiar el tr치fico)
            sleep 15
            
            # 5. 游뚿 CR칈TICO: Aplicar la nueva configuraci칩n de Nginx (Switch de tr치fico)
            # Copiar el archivo de configuraci칩n del nuevo color (blue.conf o green.conf) al default.conf
            cp ~/Proyecto-vps/nginx/${NEW_COLOR}.conf ~/Proyecto-vps/nginx/default.conf

            # 6. Actualizar Nginx y recargar
            docker exec nginx_proxy nginx -s reload
            
            # 7. Apagar contenedores antiguos
            docker stop ${OLD_BACKEND} ${OLD_FRONTEND} || true
